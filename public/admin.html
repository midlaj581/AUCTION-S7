<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PPL S7 ‚Äî Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Barlow+Condensed:ital,wght@0,300;0,400;0,600;0,700;0,800;0,900;1,400&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<script src="/socket.io/socket.io.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#08080d;--bg2:#0f0f18;--bg3:#141420;--bg4:#1c1c2a;--surface:#21212f;
  --green:#00ff87;--gd:rgba(0,255,135,0.1);--gb:rgba(0,255,135,0.2);
  --red:#ff3b5c;--rd:rgba(255,59,92,0.12);
  --yellow:#ffd166;--blue:#4cc9f0;
  --text:#f0f0ff;--td:#7777aa;--tm:#3a3a55;
  --ff:'Barlow Condensed',sans-serif;--ffr:Rajdhani,sans-serif;--ffm:'DM Mono',monospace;
}
body{background:var(--bg);color:var(--text);font-family:var(--ff);font-size:16px;min-height:100vh}

/* TOPBAR */
.topbar{background:var(--bg2);border-bottom:1px solid var(--gb);padding:0 1.5rem;height:56px;
  display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
.topbar-left{display:flex;align-items:center;gap:1rem}
.logo-img{width:36px;height:36px;object-fit:contain;border-radius:4px}
.logo-txt{font-size:1.4rem;font-weight:800;letter-spacing:0.2em;color:var(--green)}
.logo-txt span{color:var(--td);font-weight:300}
.phase-badge{padding:0.25rem 0.8rem;border-radius:20px;font-family:var(--ffm);font-size:0.68rem;letter-spacing:0.06em;border:1px solid;text-transform:uppercase}
.phase-idle{border-color:var(--tm);color:var(--tm)}
.phase-live{border-color:var(--green);color:var(--green);background:var(--gd);animation:pulseBg 2s infinite}
.phase-sold{border-color:var(--yellow);color:var(--yellow)}
.phase-unsold{border-color:var(--red);color:var(--red)}
@keyframes pulseBg{0%,100%{box-shadow:none}50%{box-shadow:0 0 12px rgba(0,255,135,0.3)}}

/* QUICK LINKS */
.links{display:flex;gap:0.5rem;padding:0.6rem 1.5rem;background:var(--bg2);border-bottom:1px solid var(--bg4);font-family:var(--ffm);font-size:0.68rem}
.links a{color:var(--green);text-decoration:none;padding:0.2rem 0.7rem;border:1px solid var(--gb);border-radius:2px;transition:all 0.15s;letter-spacing:0.05em}
.links a:hover{background:var(--gd)}
.links span{color:var(--tm);align-self:center}

/* LAYOUT */
.layout{display:grid;grid-template-columns:1fr 360px;gap:1.5rem;padding:1.5rem;max-width:1500px;margin:0 auto}
.col{display:flex;flex-direction:column;gap:1.5rem}

/* PANEL */
.panel{background:var(--bg3);border:1px solid var(--bg4);border-radius:4px;overflow:hidden}
.ph{padding:0.8rem 1.2rem;border-bottom:1px solid var(--bg4);display:flex;align-items:center;justify-content:space-between;gap:0.8rem}
.pt{font-family:var(--ffm);font-size:0.65rem;letter-spacing:0.15em;text-transform:uppercase;color:var(--td)}
.pb{padding:1.2rem}

/* STAGE ‚Äî current player on auction */
.stage{background:var(--bg3);border:1px solid var(--gb);border-radius:4px;overflow:hidden;position:relative}
.stage-inner{display:grid;grid-template-columns:160px 1fr;min-height:200px}
.stage-photo{position:relative;overflow:hidden;background:var(--bg4);flex-shrink:0}
.stage-photo img{width:100%;height:100%;object-fit:cover;object-position:top center;display:block}
.stage-pos{position:absolute;bottom:0.6rem;left:0.6rem;background:var(--green);color:#000;padding:0.2rem 0.6rem;font-weight:800;font-size:0.85rem;letter-spacing:0.1em}
.stage-info{padding:1.2rem 1.5rem;display:flex;flex-direction:column;justify-content:space-between}
.stage-name{font-size:2.2rem;font-weight:800;line-height:1;letter-spacing:0.04em;margin-bottom:0.2rem}
.stage-meta{font-family:var(--ffm);font-size:0.68rem;color:var(--td);margin-bottom:1rem}
.stage-bid-row{display:flex;align-items:flex-end;gap:1.5rem}
.bid-block{display:flex;flex-direction:column;gap:0.15rem}
.bid-lbl{font-family:var(--ffm);font-size:0.6rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--tm)}
.bid-val{font-size:2.8rem;font-weight:900;color:var(--green);line-height:1}
.bid-val.flash{animation:bidPop 0.4s ease}
@keyframes bidPop{0%{transform:scale(1)}35%{transform:scale(1.12);color:#fff;text-shadow:0 0 30px var(--green)}100%{transform:scale(1);color:var(--green)}}
.leader-chip{padding:0.3rem 0.9rem;border-radius:3px;font-size:1rem;font-weight:700;color:#000;letter-spacing:0.04em;margin-top:0.2rem;display:inline-flex;align-items:center;gap:0.5rem}
.leader-chip img{width:20px;height:20px;object-fit:contain;border-radius:2px}
.stage-idle{padding:2.5rem;text-align:center;color:var(--td);font-size:1.1rem;font-style:italic}

/* NEXT BID indicator */
.next-bid-bar{background:var(--surface);border-top:1px solid var(--bg4);padding:0.7rem 1.2rem;display:flex;align-items:center;gap:1rem;font-family:var(--ffm);font-size:0.75rem}
.next-bid-bar .label{color:var(--td);letter-spacing:0.08em}
.next-bid-bar .val{color:var(--green);font-size:0.95rem;font-weight:500}
.next-bid-bar .inc-pill{padding:0.15rem 0.6rem;border-radius:10px;background:var(--gd);border:1px solid var(--gb);color:var(--green);font-size:0.68rem}

/* BID CONTROLS */
.bid-controls{display:flex;flex-direction:column;gap:1rem}

/* Team raise buttons */
.team-raise-grid{display:grid;gap:0.6rem}
.team-raise-btn{
  display:flex;align-items:center;justify-content:space-between;
  padding:0.8rem 1rem;background:var(--surface);
  border:2px solid var(--bg4);border-radius:4px;
  cursor:pointer;transition:all 0.15s;text-align:left;gap:0.8rem;
}
.team-raise-btn:hover:not(:disabled){border-color:var(--green);background:var(--gd)}
.team-raise-btn:active:not(:disabled){transform:scale(0.98)}
.team-raise-btn:disabled{opacity:0.3;cursor:not-allowed}
.trb-left{display:flex;align-items:center;gap:0.7rem}
.trb-logo{width:32px;height:32px;object-fit:contain;border-radius:3px;flex-shrink:0;background:var(--bg4)}
.trb-name{font-size:1.1rem;font-weight:700;letter-spacing:0.04em}
.trb-budget{font-family:var(--ffm);font-size:0.65rem;opacity:0.6}
.trb-right{text-align:right;flex-shrink:0}
.trb-raise{font-family:var(--ffm);font-size:0.72rem;letter-spacing:0.06em}
.trb-next{font-size:1.1rem;font-weight:800}
.trb-warn{font-family:var(--ffm);font-size:0.6rem;color:var(--yellow)}

/* Manual bid */
.manual-bid-section{background:var(--surface);border-radius:3px;padding:1rem}
.mbs-title{font-family:var(--ffm);font-size:0.62rem;letter-spacing:0.15em;text-transform:uppercase;color:var(--td);margin-bottom:0.7rem}
.mbs-row{display:flex;gap:0.6rem;align-items:stretch}
.mbs-select{flex:0 0 160px;background:var(--bg);border:1px solid var(--bg4);color:var(--text);font-family:var(--ff);font-size:1rem;font-weight:600;padding:0.55rem 0.7rem;outline:none;border-radius:3px}
.mbs-select:focus{border-color:var(--gb)}
.mbs-input{flex:1;background:var(--bg);border:1px solid var(--bg4);color:var(--text);font-family:var(--ffm);font-size:1rem;padding:0.55rem 0.8rem;outline:none;border-radius:3px}
.mbs-input:focus{border-color:var(--gb)}
.mbs-input::placeholder{color:var(--tm);font-style:italic}
.btn{padding:0.6rem 1.1rem;border:none;font-family:var(--ff);font-size:0.95rem;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;cursor:pointer;border-radius:3px;transition:all 0.15s;display:flex;align-items:center;gap:0.4rem;white-space:nowrap}
.btn:disabled{opacity:0.3;cursor:not-allowed}
.btn-green{background:var(--green);color:#000}.btn-green:hover:not(:disabled){background:#00ffaa;box-shadow:0 0 20px rgba(0,255,135,0.35)}
.btn-red{background:var(--red);color:#fff}.btn-red:hover:not(:disabled){background:#ff5577}
.btn-yellow{background:var(--yellow);color:#000}.btn-yellow:hover:not(:disabled){background:#ffe08a}
.btn-dim{background:var(--bg4);color:var(--td);border:1px solid var(--bg4)}.btn-dim:hover:not(:disabled){border-color:var(--tm);color:var(--text)}
.btn-blue{background:var(--blue);color:#000}.btn-blue:hover:not(:disabled){background:#7dd8f8}
.btn-sm{padding:0.35rem 0.8rem;font-size:0.82rem}

/* Hammer row */
.hammer-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:0.7rem}
.hammer-row .btn{justify-content:center;padding:0.9rem 0.5rem;font-size:1rem}

/* Bid error */
.bid-err{font-family:var(--ffm);font-size:0.72rem;color:var(--red);min-height:1.1em;margin-top:0.3rem}

/* Bid log */
.bid-log{display:flex;flex-direction:column;gap:0.4rem;max-height:200px;overflow-y:auto}
.bl-entry{display:flex;align-items:center;gap:0.7rem;padding:0.45rem 0.7rem;background:var(--bg4);border-radius:2px;border-left:3px solid;font-size:0.9rem}
.bl-team{font-family:var(--ff);font-size:1rem;font-weight:700;flex:1}
.bl-amt{font-family:var(--ffm);font-size:0.82rem;color:var(--green)}
.bl-time{font-family:var(--ffm);font-size:0.6rem;color:var(--tm)}
.bl-logo{width:18px;height:18px;object-fit:contain;border-radius:2px;flex-shrink:0}

/* Players table */
.ptable{width:100%;border-collapse:collapse;font-size:0.9rem}
.ptable th{font-family:var(--ffm);font-size:0.58rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--tm);padding:0.45rem 0.7rem;text-align:left;border-bottom:1px solid var(--bg4);white-space:nowrap}
.ptable td{padding:0.4rem 0.7rem;border-bottom:1px solid rgba(28,28,42,0.6);vertical-align:middle}
.ptable tr:hover td{background:rgba(28,28,42,0.5)}
.ptable tr.row-sold td{opacity:0.4}
.ptable tr.row-live td{background:var(--gd)!important}
.ptable tr.row-unsold td{opacity:0.55}
.prow-photo{width:36px;height:36px;object-fit:cover;object-position:top;border-radius:3px;display:block;background:var(--bg4)}
.pos-pill{display:inline-block;padding:0.1rem 0.4rem;background:var(--bg4);border-radius:2px;font-family:var(--ffm);font-size:0.6rem;color:var(--td);letter-spacing:0.06em}
.status-pill{display:inline-block;padding:0.12rem 0.5rem;border-radius:2px;font-family:var(--ffm);font-size:0.6rem;letter-spacing:0.06em;text-transform:uppercase}
.sp-avail{background:var(--gd);color:var(--green);border:1px solid var(--gb)}
.sp-live{background:var(--gd);color:var(--green);border:1px solid var(--green);animation:pulseBg 1s infinite}
.sp-sold{background:rgba(255,209,102,0.1);color:var(--yellow);border:1px solid rgba(255,209,102,0.25)}
.sp-unsold{background:var(--rd);color:var(--red);border:1px solid rgba(255,59,92,0.25)}
.start-btn{padding:0.28rem 0.7rem;background:var(--green);color:#000;border:none;font-family:var(--ff);font-size:0.85rem;font-weight:700;letter-spacing:0.06em;cursor:pointer;border-radius:2px;transition:all 0.15s}
.start-btn:hover{background:#00ffaa}
.start-btn:disabled{opacity:0.3;cursor:not-allowed;background:var(--tm)}
.icon-btn{padding:0.28rem 0.5rem;background:transparent;border:1px solid var(--bg4);color:var(--td);font-size:0.75rem;cursor:pointer;border-radius:2px;transition:all 0.15s}
.icon-btn:hover.del{border-color:var(--red);color:var(--red)}
.icon-btn:hover.edit{border-color:var(--blue);color:var(--blue)}
.icon-btn:hover.reset{border-color:var(--yellow);color:var(--yellow)}
.ptable-actions{display:flex;gap:0.3rem;align-items:center;flex-wrap:nowrap}
.ptable-filter{display:flex;gap:0.4rem;flex-wrap:wrap}
.pf-btn{padding:0.25rem 0.65rem;background:transparent;border:1px solid var(--bg4);color:var(--td);font-family:var(--ffm);font-size:0.62rem;letter-spacing:0.06em;cursor:pointer;border-radius:2px;transition:all 0.15s}
.pf-btn.active{border-color:var(--gb);color:var(--green);background:var(--gd)}
.pf-btn:hover{border-color:var(--tm);color:var(--text)}
.psearch{background:var(--bg);border:1px solid var(--bg4);color:var(--text);font-family:var(--ff);font-size:0.9rem;padding:0.3rem 0.7rem;outline:none;border-radius:2px;width:180px}
.psearch:focus{border-color:var(--gb)}

/* Add/Edit player form */
.aform{display:grid;grid-template-columns:1fr 1fr;gap:0.6rem}
.aform .full{grid-column:1/-1}
.fl{font-family:var(--ffm);font-size:0.6rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--td);display:block;margin-bottom:0.2rem}
.fi,.fsel{width:100%;background:var(--bg);border:1px solid var(--bg4);color:var(--text);font-family:var(--ff);font-size:1rem;padding:0.45rem 0.7rem;outline:none;border-radius:3px;transition:border-color 0.15s}
.fi:focus,.fsel:focus{border-color:var(--gb)}
.fsel option{background:var(--bg3)}

/* Teams panel */
.team-card{background:var(--bg4);border-radius:4px;padding:1rem;border-left:4px solid;margin-bottom:0.8rem;display:flex;flex-direction:column;gap:0.6rem}
.tc-header{display:flex;align-items:center;gap:0.8rem;justify-content:space-between}
.tc-logo{width:44px;height:44px;object-fit:contain;border-radius:4px;background:var(--bg3);flex-shrink:0;padding:2px}
.tc-info{flex:1}
.tc-name{font-size:1.1rem;font-weight:800;letter-spacing:0.04em;line-height:1}
.tc-budget-row{display:flex;gap:1rem;font-family:var(--ffm);font-size:0.65rem;color:var(--td)}
.tc-budget-row span{color:var(--text)}
.tc-bar-wrap{height:4px;background:var(--bg3);border-radius:2px;overflow:hidden}
.tc-bar{height:100%;border-radius:2px;transition:width 0.6s}
.tc-players-wrap{display:flex;flex-wrap:wrap;gap:0.3rem}
.tc-player-chip{padding:0.15rem 0.5rem;background:rgba(0,0,0,0.3);border-radius:2px;font-size:0.78rem;color:var(--td)}
.tc-actions{display:flex;gap:0.4rem}
.max-bid-label{font-family:var(--ffm);font-size:0.62rem;color:var(--td);margin-top:0.2rem}
.max-bid-label span{color:var(--yellow)}

/* Team form modal */
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,0.8);backdrop-filter:blur(10px);z-index:200;display:none;align-items:center;justify-content:center;padding:2rem}
.modal-bg.open{display:flex}
.modal{background:var(--bg3);border:1px solid var(--gb);padding:2rem;width:100%;max-width:480px;position:relative;border-radius:4px}
.modal h3{font-size:1.5rem;font-weight:800;margin-bottom:1.2rem;color:var(--green)}
.modal-close{position:absolute;top:1rem;right:1rem;background:transparent;border:1px solid var(--bg4);color:var(--td);width:30px;height:30px;cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center;border-radius:2px}
.modal-close:hover{border-color:var(--red);color:var(--red)}
.color-preview{width:40px;height:40px;border-radius:3px;border:2px solid var(--bg4);flex-shrink:0;cursor:pointer;overflow:hidden;position:relative}
.color-preview input[type=color]{position:absolute;inset:0;width:100%;height:100%;opacity:0;cursor:pointer}

/* Settings */
.settings-grid{display:grid;grid-template-columns:1fr 1fr;gap:0.8rem}
.settings-grid .full{grid-column:1/-1}
.inc-display{font-family:var(--ffm);font-size:0.72rem;color:var(--td);padding:0.5rem 0;border-top:1px solid var(--bg4);margin-top:0.3rem}
.inc-display span{color:var(--green)}

/* Sold panel */
.sold-item{display:flex;align-items:center;gap:0.7rem;padding:0.4rem 0;border-bottom:1px solid var(--bg4);font-size:0.85rem}
.sold-item:last-child{border-bottom:none}
.si-name{font-family:var(--ff);font-size:0.95rem;font-weight:700;flex:1}
.si-pos{font-family:var(--ffm);font-size:0.6rem;color:var(--td)}
.si-price{font-family:var(--ffm);font-size:0.78rem;color:var(--green)}
.si-team{font-family:var(--ff);font-size:0.85rem;font-weight:600}
.si-tlogo{width:18px;height:18px;object-fit:contain;border-radius:2px}

::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--bg4)}
</style>
</head>
<body>

<!-- TOPBAR -->
<div class="topbar">
  <div class="topbar-left">
    <img id="leagueLogo" class="logo-img" src="" alt="" style="display:none"/>
    <div class="logo-txt">PPL <span id="leagueSeason">S7</span></div>
    <div class="phase-badge phase-idle" id="phaseBadge">IDLE</div>
  </div>
  <div style="display:flex;gap:0.6rem">
    <button class="btn btn-dim btn-sm" onclick="openSettings()">‚öô Settings</button>
  </div>
</div>
<div class="links">
  <span>Open on devices ‚Üí</span>
  <a href="/projector.html" target="_blank">üñ• Projector</a>
  <a href="/manager.html" target="_blank">üë§ Manager</a>
</div>

<div class="layout">
<!-- LEFT COL -->
<div class="col">

  <!-- STAGE -->
  <div class="stage" id="stage">
    <div class="stage-idle" id="stageIdle">‚öΩ Select a player below to start the auction</div>
    <div class="stage-inner" id="stageContent" style="display:none">
      <div class="stage-photo">
        <img id="sPhoto" src="" alt=""/>
        <div class="stage-pos" id="sPos"></div>
      </div>
      <div class="stage-info">
        <div>
          <div class="stage-name" id="sName"></div>
          <div class="stage-meta" id="sMeta"></div>
        </div>
        <div class="stage-bid-row">
          <div class="bid-block">
            <div class="bid-lbl">Current Bid</div>
            <div class="bid-val" id="sBidVal"></div>
          </div>
          <div class="bid-block">
            <div class="bid-lbl">Leading</div>
            <div id="sLeader" class="leader-chip" style="background:#333;color:#aaa">‚Äî</div>
          </div>
        </div>
      </div>
    </div>
    <div class="next-bid-bar" id="nextBidBar" style="display:none">
      <span class="label">NEXT BID</span>
      <span class="val" id="nextBidVal"></span>
      <span class="inc-pill" id="incPill"></span>
      <span style="flex:1"></span>
      <span class="label" style="font-size:0.6rem" id="threshNote"></span>
    </div>
  </div>

  <!-- BID CONTROLS -->
  <div class="panel">
    <div class="ph"><span class="pt">Bid Controls ‚Äî Physical Auction</span><span class="bid-err" id="bidErr"></span></div>
    <div class="pb bid-controls">

      <!-- Team raise buttons -->
      <div>
        <div style="font-family:var(--ffm);font-size:0.6rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--tm);margin-bottom:0.6rem">Click team when they raise their paddle ‚Üì</div>
        <div class="team-raise-grid" id="teamRaiseGrid"></div>
      </div>

      <!-- Manual bid -->
      <div class="manual-bid-section">
        <div class="mbs-title">Manual Bid Entry (type exact amount)</div>
        <div class="mbs-row">
          <select class="mbs-select" id="manualTeamSel"></select>
          <input class="mbs-input" id="manualAmt" type="number" placeholder="‚Çπ Amount" min="1"/>
          <button class="btn btn-blue" onclick="placeManualBid()">Place</button>
        </div>
      </div>

      <!-- Hammer -->
      <div class="hammer-row">
        <button class="btn btn-green" id="btnSold" onclick="doSold()" disabled>üî® SOLD!</button>
        <button class="btn btn-red"   id="btnUnsold" onclick="doUnsold()" disabled>‚úó UNSOLD</button>
        <button class="btn btn-dim"   onclick="doIdle()">‚Ü© Reset</button>
      </div>

    </div>
  </div>

  <!-- BID LOG -->
  <div class="panel">
    <div class="ph"><span class="pt">Bid Log</span><span id="bidCount" style="font-family:var(--ffm);font-size:0.65rem;color:var(--tm)"></span></div>
    <div class="pb"><div class="bid-log" id="bidLog"><div style="color:var(--tm);font-style:italic;font-size:0.9rem">No bids yet</div></div></div>
  </div>

  <!-- PLAYER POOL -->
  <div class="panel">
    <div class="ph" style="flex-wrap:wrap;gap:0.5rem">
      <span class="pt">Player Pool</span>
      <div style="display:flex;gap:0.5rem;align-items:center;flex-wrap:wrap">
        <input class="psearch" id="pSearch" placeholder="Search player‚Ä¶" oninput="renderPlayers()"/>
        <div class="ptable-filter" id="posFilter"></div>
      </div>
      <span id="pCount" style="font-family:var(--ffm);font-size:0.62rem;color:var(--tm)"></span>
    </div>
    <div style="overflow-x:auto">
      <table class="ptable">
        <thead><tr>
          <th></th><th>Name</th><th>Pos</th><th>Rtg</th><th>Base</th><th>Status</th><th>Actions</th>
        </tr></thead>
        <tbody id="playersTbody"></tbody>
      </table>
    </div>
  </div>

  <!-- ADD PLAYER FORM -->
  <div class="panel">
    <div class="ph"><span class="pt" id="addFormTitle">Add New Player</span></div>
    <div class="pb">
      <input type="hidden" id="editPlayerId"/>
      <div class="aform">
        <div>
          <label class="fl">Full Name *</label>
          <input class="fi" id="pName" placeholder="e.g. Sajith Thomas"/>
        </div>
        <div>
          <label class="fl">Position *</label>
          <select class="fsel" id="pPos">
            <option>GK</option><option>CB</option><option>LB</option><option>RB</option>
            <option>CDM</option><option>CM</option><option>CAM</option>
            <option>LW</option><option>RW</option><option selected>ST</option>
          </select>
        </div>
        <div>
          <label class="fl">Rating (1‚Äì99)</label>
          <input class="fi" id="pRating" type="number" min="1" max="99" placeholder="80"/>
        </div>
        <div>
          <label class="fl">Base Price (‚Çπ) *</label>
          <input class="fi" id="pBase" type="number" placeholder="100"/>
        </div>
        <div class="full">
          <label class="fl">Photo URL (optional ‚Äî leave blank for auto avatar)</label>
          <input class="fi" id="pPhoto" placeholder="https://‚Ä¶ paste direct image link"/>
        </div>
      </div>
      <div style="display:flex;gap:0.6rem;margin-top:0.8rem">
        <button class="btn btn-green" style="flex:1" onclick="savePlayer()">+ Save Player</button>
        <button class="btn btn-dim" id="cancelEditBtn" onclick="cancelEdit()" style="display:none">‚úï Cancel</button>
      </div>
    </div>
  </div>

</div><!-- /col left -->

<!-- RIGHT COL -->
<div class="col">

  <!-- TEAMS -->
  <div class="panel">
    <div class="ph">
      <span class="pt">Teams</span>
      <button class="btn btn-green btn-sm" onclick="openTeamModal(null)">+ Add Team</button>
    </div>
    <div class="pb" id="teamsPanel"></div>
  </div>

  <!-- SOLD SUMMARY -->
  <div class="panel">
    <div class="ph"><span class="pt">Sold Players</span><span id="soldTotal" style="font-family:var(--ffm);font-size:0.65rem;color:var(--tm)"></span></div>
    <div class="pb" id="soldPanel"><div style="color:var(--tm);font-style:italic;font-size:0.9rem">No sales yet</div></div>
  </div>

</div>
</div><!-- /layout -->

<!-- TEAM MODAL -->
<div class="modal-bg" id="teamModal">
  <div class="modal">
    <button class="modal-close" onclick="closeTeamModal()">‚úï</button>
    <h3 id="teamModalTitle">Add Team</h3>
    <input type="hidden" id="tmId"/>
    <div style="display:flex;flex-direction:column;gap:0.7rem">
      <div><label class="fl">Team Name *</label><input class="fi" id="tmName" placeholder="e.g. Thunder FC"/></div>
      <div style="display:flex;gap:0.8rem;align-items:flex-end">
        <div style="flex:1"><label class="fl">Team Color</label><input class="fi" id="tmColor" type="color" value="#e63946" style="height:42px;padding:2px 4px;cursor:pointer"/></div>
        <div style="flex:1"><label class="fl">Budget (‚Çπ)</label><input class="fi" id="tmBudget" type="number" placeholder="8000"/></div>
      </div>
      <div><label class="fl">Logo URL (optional)</label><input class="fi" id="tmLogo" placeholder="https://‚Ä¶ paste logo image URL"/></div>
      <div id="tmLogoPreview" style="display:none;margin-top:0.3rem">
        <img id="tmLogoImg" src="" alt="" style="width:60px;height:60px;object-fit:contain;border-radius:4px;background:var(--bg4);padding:4px"/>
      </div>
      <button class="btn btn-green" style="margin-top:0.4rem;width:100%;justify-content:center" onclick="saveTeam()">Save Team</button>
    </div>
  </div>
</div>

<!-- SETTINGS MODAL -->
<div class="modal-bg" id="settingsModal">
  <div class="modal">
    <button class="modal-close" onclick="document.getElementById('settingsModal').classList.remove('open')">‚úï</button>
    <h3>‚öô League Settings</h3>
    <div class="settings-grid">
      <div class="full"><label class="fl">League Name</label><input class="fi" id="cfgName" placeholder="Premier Player League"/></div>
      <div class="full"><label class="fl">Season</label><input class="fi" id="cfgSeason" placeholder="Season 7"/></div>
      <div class="full"><label class="fl">League Logo URL</label><input class="fi" id="cfgLogo" placeholder="https://‚Ä¶" oninput="previewCfgLogo()"/></div>
      <div id="cfgLogoPreview" style="display:none;grid-column:1/-1">
        <img id="cfgLogoImg" src="" alt="" style="width:64px;height:64px;object-fit:contain;background:var(--bg4);padding:4px;border-radius:4px"/>
      </div>
      <div><label class="fl">Min Players per Team</label><input class="fi" id="cfgMinPlayers" type="number" min="1"/></div>
      <div></div>
      <div><label class="fl">Bid Threshold (‚Çπ)</label><input class="fi" id="cfgThreshold" type="number"/></div>
      <div></div>
      <div><label class="fl">Increment BELOW threshold</label><input class="fi" id="cfgHighInc" type="number"/></div>
      <div><label class="fl">Increment AT/ABOVE threshold</label><input class="fi" id="cfgLowInc" type="number"/></div>
    </div>
    <div class="inc-display" id="incDisplay"></div>
    <button class="btn btn-green" style="width:100%;justify-content:center;margin-top:1rem" onclick="saveSettings()">Save Settings</button>
  </div>
</div>

<!-- EDIT PLAYER MODAL -->
<div class="modal-bg" id="editModal">
  <div class="modal">
    <button class="modal-close" onclick="closeEditModal()">‚úï</button>
    <h3>Edit Player</h3>
    <input type="hidden" id="emId"/>
    <div class="aform">
      <div><label class="fl">Name</label><input class="fi" id="emName"/></div>
      <div><label class="fl">Position</label>
        <select class="fsel" id="emPos">
          <option>GK</option><option>CB</option><option>LB</option><option>RB</option>
          <option>CDM</option><option>CM</option><option>CAM</option><option>LW</option><option>RW</option><option>ST</option>
        </select>
      </div>
      <div><label class="fl">Rating</label><input class="fi" id="emRating" type="number" min="1" max="99"/></div>
      <div><label class="fl">Base Price (‚Çπ)</label><input class="fi" id="emBase" type="number"/></div>
      <div class="full"><label class="fl">Photo URL</label><input class="fi" id="emPhoto" placeholder="Blank = auto avatar"/></div>
    </div>
    <button class="btn btn-green" style="width:100%;justify-content:center;margin-top:0.8rem" onclick="saveEditPlayer()">Save</button>
  </div>
</div>

<script>
const socket = io();
let S = { auctionState:{phase:'idle',currentBid:0,bidHistory:[],soldPlayers:[]}, teams:[], players:[], config:{} };
let posFilter = 'ALL';

socket.on('stateUpdate', data => { S = data; render(); });
socket.on('bidFlash', () => {
  const el = document.getElementById('sBidVal');
  el.classList.remove('flash'); void el.offsetWidth; el.classList.add('flash');
});
socket.on('bidError', ({msg}) => {
  const el = document.getElementById('bidErr');
  el.textContent = msg;
  setTimeout(()=>el.textContent='', 4000);
});

// ‚îÄ‚îÄ RENDER ALL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function render() {
  const { auctionState:as, teams, players, config } = S;
  renderPhaseBadge(as.phase);
  renderLeagueBranding(config);
  renderStage(as, config);
  renderTeamRaiseGrid(as, teams, config);
  renderManualSelects(teams);
  renderTeams(as, teams, config);
  renderPlayers();
  renderBidLog(as.bidHistory);
  renderSoldPanel(as.soldPlayers);
  renderPosFilters(players);
}

function renderPhaseBadge(phase) {
  const b = document.getElementById('phaseBadge');
  b.className = `phase-badge phase-${phase}`;
  b.textContent = phase.toUpperCase();
}

function renderLeagueBranding(cfg) {
  document.getElementById('leagueSeason').textContent = cfg.leagueSeason?.replace(/season\s*/i,'S') || 'S7';
  const logo = document.getElementById('leagueLogo');
  if (cfg.leagueLogo) { logo.src = cfg.leagueLogo; logo.style.display = 'block'; }
  else logo.style.display = 'none';
}

function renderStage(as, config) {
  const { phase, currentPlayer:p, currentBid, leadingTeam } = as;
  const idle = document.getElementById('stageIdle');
  const content = document.getElementById('stageContent');
  const nbb = document.getElementById('nextBidBar');
  const btnSold = document.getElementById('btnSold');
  const btnUnsold = document.getElementById('btnUnsold');

  if (!p || phase === 'idle') {
    idle.style.display = ''; content.style.display = 'none'; nbb.style.display = 'none';
    btnSold.disabled = true; btnUnsold.disabled = true; return;
  }

  idle.style.display = 'none'; content.style.display = ''; nbb.style.display = 'flex';

  document.getElementById('sPhoto').src = p.photo;
  document.getElementById('sPos').textContent = p.position;
  document.getElementById('sName').textContent = p.name;
  document.getElementById('sMeta').textContent = `Rating: ${p.rating}  ¬∑  Base Price: ‚Çπ${p.basePrice}  ¬∑  ID #${p.id}`;
  document.getElementById('sBidVal').textContent = `‚Çπ${currentBid.toLocaleString()}`;

  const ldr = document.getElementById('sLeader');
  if (leadingTeam) {
    ldr.innerHTML = `${leadingTeam.logo ? `<img src="${leadingTeam.logo}" alt=""/>` : ''} ${leadingTeam.name}`;
    ldr.style.background = leadingTeam.color; ldr.style.color = '#000';
  } else {
    ldr.innerHTML = '‚Äî No bids yet ‚Äî'; ldr.style.background = '#2a2a3a'; ldr.style.color = '#7777aa';
  }

  // Next bid display
  const inc = getIncrement(currentBid, config);
  const nextBid = currentBid + inc;
  document.getElementById('nextBidVal').textContent = `‚Çπ${nextBid.toLocaleString()}`;
  document.getElementById('incPill').textContent = `+‚Çπ${inc}`;
  const thresh = config.thresholdBid ?? 200;
  document.getElementById('threshNote').textContent = currentBid < thresh
    ? `Switching to +‚Çπ${config.lowIncrement} at ‚Çπ${thresh}`
    : `Using +‚Çπ${config.lowIncrement} (above ‚Çπ${thresh})`;

  btnSold.disabled   = !leadingTeam || phase !== 'live';
  btnUnsold.disabled = phase !== 'live';
}

function renderTeamRaiseGrid(as, teams, config) {
  const { phase, currentBid } = as;
  const div = document.getElementById('teamRaiseGrid');
  const cols = teams.length <= 2 ? '1fr 1fr' : teams.length === 3 ? '1fr 1fr 1fr' : '1fr 1fr';
  div.style.gridTemplateColumns = cols;

  div.innerHTML = teams.map(t => {
    const remaining = t.budget - t.spent;
    const maxBid    = phase === 'live' ? getTeamMaxBidClient(t, as, config) : 0;
    const inc       = getIncrement(currentBid, config);
    const nextBid   = currentBid + inc;
    const canBid    = phase === 'live' && nextBid <= maxBid && nextBid <= remaining;
    const overBudget = phase === 'live' && remaining < nextBid;
    const reserveIssue = phase === 'live' && !overBudget && nextBid > maxBid;

    let warn = '';
    if (overBudget) warn = `‚ö† No budget`;
    else if (reserveIssue) warn = `‚ö† Must save for ${config.minPlayersPerTeam - t.players.length - 1} more`;

    return `<button class="team-raise-btn" style="border-color:${canBid ? t.color : '#2a2a3a'}" 
        onclick="raiseForTeam('${t.id}')" ${canBid?'':'disabled'}>
      <div class="trb-left">
        ${t.logo ? `<img class="trb-logo" src="${t.logo}" alt=""/>` : `<div class="trb-logo" style="border-radius:50%;background:${t.color};opacity:0.3"></div>`}
        <div>
          <div class="trb-name" style="color:${t.color}">${t.name}</div>
          <div class="trb-budget">‚Çπ${remaining.toLocaleString()} left ¬∑ ${t.players.length} players</div>
          ${warn ? `<div class="trb-warn">${warn}</div>` : ''}
        </div>
      </div>
      <div class="trb-right">
        <div class="trb-raise" style="color:${canBid?'#7777aa':'#3a3a55'}">RAISE TO</div>
        <div class="trb-next" style="color:${canBid?t.color:'#3a3a55'}">‚Çπ${nextBid.toLocaleString()}</div>
        ${phase==='live'&&!canBid?'':`<div class="trb-raise" style="color:#3a3a55;font-size:0.58rem">+‚Çπ${inc}</div>`}
      </div>
    </button>`;
  }).join('');
}

function renderManualSelects(teams) {
  const sel = document.getElementById('manualTeamSel');
  const cur = sel.value;
  sel.innerHTML = teams.map(t=>`<option value="${t.id}">${t.name}</option>`).join('');
  if (cur) sel.value = cur;
}

function renderTeams(as, teams, config) {
  const div = document.getElementById('teamsPanel');
  div.innerHTML = teams.map(t => {
    const remaining = t.budget - t.spent;
    const pct = Math.max(0, (remaining / t.budget) * 100);
    const maxBid = as.phase === 'live' ? getTeamMaxBidClient(t, as, config) : remaining;
    const needMore = Math.max(0, config.minPlayersPerTeam - t.players.length);
    return `<div class="team-card" style="border-left-color:${t.color}">
      <div class="tc-header">
        ${t.logo ? `<img class="tc-logo" src="${t.logo}" alt=""/>` : `<div class="tc-logo" style="border-radius:50%;background:${t.color};opacity:0.2"></div>`}
        <div class="tc-info">
          <div class="tc-name" style="color:${t.color}">${t.name}</div>
          <div class="tc-budget-row">
            <span>Budget: <span>‚Çπ${t.budget.toLocaleString()}</span></span>
            <span>Spent: <span style="color:var(--yellow)">‚Çπ${t.spent.toLocaleString()}</span></span>
            <span>Left: <span style="color:var(--green)">‚Çπ${remaining.toLocaleString()}</span></span>
          </div>
          ${as.phase === 'live' ? `<div class="max-bid-label">Max bid now: <span>‚Çπ${maxBid.toLocaleString()}</span> ¬∑ Still need: <span>${needMore} player${needMore!==1?'s':''}</span></div>` : `<div class="max-bid-label">Players needed: <span>${needMore}</span></div>`}
        </div>
        <div class="tc-actions">
          <button class="btn btn-dim btn-sm" onclick="openTeamModal('${t.id}')">‚úè</button>
          <button class="btn btn-dim btn-sm" onclick="removeTeam('${t.id}')" style="color:var(--red)">‚úï</button>
        </div>
      </div>
      <div class="tc-bar-wrap"><div class="tc-bar" style="width:${pct}%;background:${t.color}"></div></div>
      <div class="tc-players-wrap">${t.players.map(p=>`<span class="tc-player-chip"><span style="color:${t.color}">${p.position}</span> ${p.name}</span>`).join('')}</div>
    </div>`;
  }).join('');
}

function renderPlayers() {
  const tbody = document.getElementById('playersTbody');
  const { auctionState:as, players } = S;
  const search = document.getElementById('pSearch')?.value?.toLowerCase() || '';
  const avail = players.filter(p=>p.status==='available').length;
  const sold  = players.filter(p=>p.status==='sold').length;
  document.getElementById('pCount').textContent = `${avail} available ¬∑ ${sold} sold ¬∑ ${players.length - avail - sold} unsold`;

  const filtered = players.filter(p => {
    const matchPos = posFilter === 'ALL' || p.position === posFilter;
    const matchSearch = !search || p.name.toLowerCase().includes(search);
    return matchPos && matchSearch;
  });

  tbody.innerHTML = filtered.map(p => {
    const isLive = as.currentPlayer?.id === p.id && as.phase === 'live';
    const cls = isLive ? 'row-live' : p.status === 'sold' ? 'row-sold' : p.status === 'unsold' ? 'row-unsold' : '';
    const statusEl = isLive
      ? `<span class="status-pill sp-live">LIVE</span>`
      : p.status === 'sold'
      ? `<span class="status-pill sp-sold">SOLD ‚Çπ${(p.soldPrice||0).toLocaleString()}</span>`
      : p.status === 'unsold'
      ? `<span class="status-pill sp-unsold">UNSOLD</span>`
      : `<span class="status-pill sp-avail">AVAIL</span>`;
    const canStart = p.status === 'available' && as.phase === 'idle';
    return `<tr class="${cls}">
      <td><img class="prow-photo" src="${p.photo}" alt=""/></td>
      <td style="font-family:var(--ff);font-weight:700;font-size:1rem">${p.name}</td>
      <td><span class="pos-pill">${p.position}</span></td>
      <td style="font-family:var(--ffm);font-size:0.8rem;color:var(--green)">${p.rating}</td>
      <td style="font-family:var(--ffm);font-size:0.78rem">‚Çπ${p.basePrice}</td>
      <td>${statusEl}</td>
      <td><div class="ptable-actions">
        <button class="start-btn" onclick="startAuction(${p.id})" ${canStart?'':'disabled'}>‚ñ∂</button>
        <button class="icon-btn edit" onclick="openEditModal(${p.id})">‚úè</button>
        ${p.status==='unsold'?`<button class="icon-btn reset" onclick="resetPlayer(${p.id})">‚Ü©</button>`:''}
        ${p.status==='available'?`<button class="icon-btn del" onclick="removePlayer(${p.id})">‚úï</button>`:''}
      </div></td>
    </tr>`;
  }).join('');
}

function renderBidLog(bids) {
  const div = document.getElementById('bidLog');
  document.getElementById('bidCount').textContent = bids?.length ? `${bids.length} bid${bids.length!==1?'s':''}` : '';
  if (!bids?.length) { div.innerHTML = '<div style="color:var(--tm);font-style:italic;font-size:0.9rem">No bids yet</div>'; return; }
  div.innerHTML = bids.slice(0,25).map((b,i) => `
    <div class="bl-entry" style="border-left-color:${b.color}">
      ${b.logo?`<img class="bl-logo" src="${b.logo}" alt=""/>`:''}
      <span class="bl-team" style="color:${b.color}">${i===0?'üèÜ ':''}${b.team}</span>
      <span class="bl-amt">‚Çπ${b.amount.toLocaleString()}</span>
      <span class="bl-time">${timeAgo(b.ts)}</span>
    </div>`).join('');
}

function renderSoldPanel(sold) {
  const div = document.getElementById('soldPanel');
  const total = sold?.reduce((s,x)=>s+x.price,0) || 0;
  document.getElementById('soldTotal').textContent = sold?.length ? `${sold.length} sold ¬∑ ‚Çπ${total.toLocaleString()} total` : '';
  if (!sold?.length) { div.innerHTML = '<div style="color:var(--tm);font-style:italic;font-size:0.9rem">No sales yet</div>'; return; }
  div.innerHTML = [...sold].reverse().map(s => `
    <div class="sold-item">
      <img class="prow-photo" src="${s.player.photo}" alt="" style="width:30px;height:30px;border-radius:2px"/>
      <div style="flex:1">
        <div class="si-name">${s.player.name} <span class="si-pos">${s.player.position}</span></div>
        <div style="display:flex;align-items:center;gap:0.4rem">
          ${s.teamLogo?`<img class="si-tlogo" src="${s.teamLogo}" alt=""/>`:''}
          <span class="si-team" style="color:${s.teamColor}">${s.team}</span>
        </div>
      </div>
      <span class="si-price">‚Çπ${s.price.toLocaleString()}</span>
    </div>`).join('');
}

function renderPosFilters(players) {
  const div = document.getElementById('posFilter');
  const positions = ['ALL', ...new Set(players.map(p=>p.position))].filter(Boolean);
  div.innerHTML = positions.map(pos => `
    <button class="pf-btn ${posFilter===pos?'active':''}" onclick="setPosFilter('${pos}')">${pos}</button>
  `).join('');
}

// ‚îÄ‚îÄ BID LOGIC HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getIncrement(currentBid, config) {
  const thresh = config.thresholdBid ?? 200;
  const hi     = config.highIncrement ?? 20;
  const lo     = config.lowIncrement  ?? 10;
  return currentBid < thresh ? hi : lo;
}

function getTeamMaxBidClient(team, as, config) {
  const remaining  = team.budget - team.spent;
  const haveNow    = team.players.length;
  const stillNeed  = Math.max(0, (config.minPlayersPerTeam ?? 10) - haveNow - 1);
  if (stillNeed === 0) return remaining;

  const pool = S.players
    .filter(p => p.status === 'available' && p.id !== as.currentPlayer?.id)
    .map(p => p.basePrice).sort((a,b)=>a-b).slice(0, stillNeed);

  while (pool.length < stillNeed) pool.push(pool[pool.length-1] ?? 0);
  const reserve = pool.reduce((s,v)=>s+v, 0);
  return Math.max(0, remaining - reserve);
}

// ‚îÄ‚îÄ ACTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startAuction(id)  { socket.emit('admin:startAuction', { playerId:id }); }
function doSold()          { if(confirm('‚ö° Confirm SOLD?')) socket.emit('admin:sold'); }
function doUnsold()        { socket.emit('admin:unsold'); }
function doIdle()          { socket.emit('admin:idle'); }

function raiseForTeam(teamId) {
  const { currentBid } = S.auctionState;
  const inc = getIncrement(currentBid, S.config);
  socket.emit('placeBid', { teamId, amount: currentBid + inc });
}

function placeManualBid() {
  const teamId = document.getElementById('manualTeamSel').value;
  const amount = parseFloat(document.getElementById('manualAmt').value);
  if (!amount || isNaN(amount)) { document.getElementById('bidErr').textContent = 'Enter a valid amount.'; return; }
  socket.emit('placeBid', { teamId, amount });
  document.getElementById('manualAmt').value = '';
}

function removePlayer(id) { if(confirm('Remove player?')) socket.emit('admin:removePlayer', { playerId:id }); }
function resetPlayer(id)  { socket.emit('admin:resetPlayer', { playerId:id }); }
function removeTeam(id)   { if(confirm('Remove team? (Their players/bids remain in log)')) socket.emit('admin:removeTeam', { teamId:id }); }

function setPosFilter(pos) { posFilter = pos; renderPlayers(); }

// ‚îÄ‚îÄ SAVE PLAYER (Add) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function savePlayer() {
  const name = document.getElementById('pName').value.trim();
  const base = parseFloat(document.getElementById('pBase').value);
  if (!name || !base) { alert('Name and base price required.'); return; }
  socket.emit('admin:addPlayer', {
    name, position: document.getElementById('pPos').value,
    rating: parseInt(document.getElementById('pRating').value) || 75,
    basePrice: base, photo: document.getElementById('pPhoto').value.trim(),
  });
  ['pName','pBase','pRating','pPhoto'].forEach(id => document.getElementById(id).value='');
}

// ‚îÄ‚îÄ EDIT PLAYER MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openEditModal(id) {
  const p = S.players.find(x=>x.id===id); if(!p) return;
  document.getElementById('emId').value    = p.id;
  document.getElementById('emName').value  = p.name;
  document.getElementById('emPos').value   = p.position;
  document.getElementById('emRating').value= p.rating;
  document.getElementById('emBase').value  = p.basePrice;
  document.getElementById('emPhoto').value = p.photo || '';
  document.getElementById('editModal').classList.add('open');
}
function closeEditModal() { document.getElementById('editModal').classList.remove('open'); }
function saveEditPlayer() {
  const id = parseInt(document.getElementById('emId').value);
  socket.emit('admin:editPlayer', {
    id, name: document.getElementById('emName').value.trim(),
    position: document.getElementById('emPos').value,
    rating: parseInt(document.getElementById('emRating').value) || 75,
    basePrice: parseFloat(document.getElementById('emBase').value) || 100,
    photo: document.getElementById('emPhoto').value.trim(),
  });
  closeEditModal();
}
function cancelEdit() { document.getElementById('editPlayerId').value=''; document.getElementById('addFormTitle').textContent='Add New Player'; document.getElementById('cancelEditBtn').style.display='none'; }

// ‚îÄ‚îÄ TEAM MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openTeamModal(id) {
  const t = id ? S.teams.find(x=>x.id===id) : null;
  document.getElementById('teamModalTitle').textContent = t ? 'Edit Team' : 'Add Team';
  document.getElementById('tmId').value     = t?.id || ('T'+(Date.now()%10000));
  document.getElementById('tmName').value   = t?.name || '';
  document.getElementById('tmColor').value  = t?.color || '#e63946';
  document.getElementById('tmBudget').value = t?.budget || 8000;
  document.getElementById('tmLogo').value   = t?.logo || '';
  const prev = document.getElementById('tmLogoPreview');
  const img  = document.getElementById('tmLogoImg');
  if (t?.logo) { img.src=t.logo; prev.style.display='block'; } else prev.style.display='none';
  document.getElementById('tmLogo').oninput = () => {
    const v = document.getElementById('tmLogo').value.trim();
    if(v){img.src=v;prev.style.display='block';}else prev.style.display='none';
  };
  document.getElementById('teamModal').classList.add('open');
}
function closeTeamModal() { document.getElementById('teamModal').classList.remove('open'); }
function saveTeam() {
  const name = document.getElementById('tmName').value.trim();
  const budget = parseFloat(document.getElementById('tmBudget').value);
  if (!name||!budget) { alert('Name and budget required.'); return; }
  socket.emit('admin:saveTeam', {
    id: document.getElementById('tmId').value,
    name, color: document.getElementById('tmColor').value,
    budget, logo: document.getElementById('tmLogo').value.trim(),
  });
  closeTeamModal();
}

// ‚îÄ‚îÄ SETTINGS MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openSettings() {
  const cfg = S.config;
  document.getElementById('cfgName').value       = cfg.leagueName || '';
  document.getElementById('cfgSeason').value     = cfg.leagueSeason || '';
  document.getElementById('cfgLogo').value       = cfg.leagueLogo || '';
  document.getElementById('cfgMinPlayers').value = cfg.minPlayersPerTeam || 10;
  document.getElementById('cfgThreshold').value  = cfg.thresholdBid || 200;
  document.getElementById('cfgHighInc').value    = cfg.highIncrement || 20;
  document.getElementById('cfgLowInc').value     = cfg.lowIncrement || 10;
  updateIncDisplay();
  const prev = document.getElementById('cfgLogoPreview');
  if (cfg.leagueLogo) { document.getElementById('cfgLogoImg').src=cfg.leagueLogo; prev.style.display='block'; }
  else prev.style.display='none';
  document.getElementById('settingsModal').classList.add('open');
}
function previewCfgLogo() {
  const v = document.getElementById('cfgLogo').value.trim();
  const prev = document.getElementById('cfgLogoPreview');
  if(v){document.getElementById('cfgLogoImg').src=v;prev.style.display='block';}else prev.style.display='none';
}
function updateIncDisplay() {
  const t=parseInt(document.getElementById('cfgThreshold').value)||200;
  const hi=parseInt(document.getElementById('cfgHighInc').value)||20;
  const lo=parseInt(document.getElementById('cfgLowInc').value)||10;
  document.getElementById('incDisplay').innerHTML=`Increment: <span>+‚Çπ${hi}</span> while bid &lt; ‚Çπ${t} ‚Üí switches to <span>+‚Çπ${lo}</span> at ‚Çπ${t}+`;
}
['cfgThreshold','cfgHighInc','cfgLowInc'].forEach(id=>document.getElementById(id)?.addEventListener('input',updateIncDisplay));
function saveSettings() {
  socket.emit('admin:updateConfig', {
    leagueName:        document.getElementById('cfgName').value.trim(),
    leagueSeason:      document.getElementById('cfgSeason').value.trim(),
    leagueLogo:        document.getElementById('cfgLogo').value.trim(),
    minPlayersPerTeam: parseInt(document.getElementById('cfgMinPlayers').value)||10,
    thresholdBid:      parseInt(document.getElementById('cfgThreshold').value)||200,
    highIncrement:     parseInt(document.getElementById('cfgHighInc').value)||20,
    lowIncrement:      parseInt(document.getElementById('cfgLowInc').value)||10,
  });
  document.getElementById('settingsModal').classList.remove('open');
}

// ‚îÄ‚îÄ CLOSE MODALS on backdrop ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.querySelectorAll('.modal-bg').forEach(el => {
  el.addEventListener('click', e => { if(e.target===el) el.classList.remove('open'); });
});
document.addEventListener('keydown', e => {
  if(e.key==='Escape') document.querySelectorAll('.modal-bg.open').forEach(el=>el.classList.remove('open'));
});

function timeAgo(ts) {
  const s=Math.floor((Date.now()-ts)/1000);
  if(s<60) return `${s}s`; if(s<3600) return `${Math.floor(s/60)}m`; return `${Math.floor(s/3600)}h`;
}

render();
</script>
</body>
</html>
